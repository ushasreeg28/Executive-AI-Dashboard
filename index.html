<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Stock Dashboard | Ushasree</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100vh; 
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body { 
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: white;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(20px);
            padding: 1rem 5%;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: 1.6rem;
            font-weight: 800;
            background: linear-gradient(45deg, #00d4ff, #7b68ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.2rem;
        }
        
        .header-subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
            color: #a0a0c0;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem 5%;
            gap: 1rem;
            overflow: hidden;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            flex-shrink: 0;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            border-color: rgba(0,212,255,0.5);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 0.3rem;
        }
        
        .stat-label { font-size: 0.8rem; opacity: 0.8; }
        
        .status {
            background: rgba(40,167,69,0.2);
            border: 1px solid rgba(40,167,69,0.4);
            padding: 0.8rem;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        .chart-container {
            flex: 1;
            background: rgba(0,0,0,0.4);
            border-radius: 20px;
            padding: 1rem;  /* Reduced padding */
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            overflow: hidden;
            position: relative;
            display: block;  /* Changed from flex */
        }

        #stock-chart {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        .footer {
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(20px);
            text-align: center;
            padding: 0.8rem 5%;
            border-top: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
            font-size: 0.85rem;
        }
        
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.3rem; }
            .header-subtitle { font-size: 0.75rem; }
            .stat-value { font-size: 1.5rem; }
            .main-content { padding: 1rem 3%; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <h1>ðŸ“ˆ Live Stock Dashboard</h1>
        <p class="header-subtitle">IBM â€¢ Firebase + D3.js â€¢ Real-time</p>
    </header>

    <div class="main-content">
        <!-- STATS -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="live-price">$145.23</div>
                <div class="stat-label">Current Price</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="change-val">+1.45%</div>
                <div class="stat-label pulse" id="change-label">24hr Change</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="volume-val">8.4M</div>
                <div class="stat-label">Volume</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="points-count">47</div>
                <div class="stat-label">Data Points</div>
            </div>
        </div>

        <!-- STATUS -->
        <div class="status" id="status">
            ðŸ”„ Connecting to Firebase...
        </div>

        <!-- CHART -->
        <div class="chart-container">
            <svg id="stock-chart"></svg>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
        <strong>D3.js â€¢ Firebase Realtime Database</strong> | 
        <a href="https://github.com/ushasree28g" style="color:#00d4ff">Ushasree</a> | 2026
    </footer>

    <!-- SCRIPTS -->
    <script src="secrets.js"></script>
    <script>
        // Firebase from secrets
        const firebaseConfig = window.API_CONFIG?.firebase || {};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // State
        let prices = [];
        let currentPrice = 145.23;
        let currentChange = "+1.45%";
        let currentVolume = 8400000;
        let dataPoints = 0;

        // Live data generator
        async function fetchStockData() {
            const newPrice = currentPrice + (Math.sin(Date.now() / 10000) * 0.5) + (Math.random() - 0.5) * 0.3;
            currentPrice = Math.max(140, Math.min(155, newPrice));
            
            const newPoint = {
                time: Date.now(),
                price: currentPrice,
                volume: Math.floor(Math.random() * 5000000) + 5000000,
                change: ((Math.random() - 0.5) * 3).toFixed(2) + '%'
            };
            
            prices.push(newPoint);
            if (prices.length > 75) prices.shift();
            
            currentVolume = newPoint.volume;
            currentChange = newPoint.change;
            dataPoints = prices.length;
            
            db.ref('stocks/IBM').set(newPoint);
            document.getElementById('status').textContent = 
                `âœ… Live: $${currentPrice.toFixed(2)} | ${dataPoints} pts`;
        }

        // Update stats
        function updateStats() {
            document.getElementById('live-price').textContent = `$${currentPrice.toFixed(2)}`;
            document.getElementById('change-val').textContent = currentChange;
            document.getElementById('volume-val').textContent = (currentVolume/1000000).toFixed(1) + 'M';
            document.getElementById('points-count').textContent = dataPoints;
        }
        

        function renderChart() {
            const container = document.querySelector('.chart-container');
            const WIDTH = container.clientWidth - 20;  // Actual width
            const HEIGHT = container.clientHeight - 10;  // Actual height
            
            const svg = d3.select("#stock-chart");
            svg.attr("width", WIDTH).attr("height", HEIGHT).selectAll("*").remove();
            
            if (prices.length < 5) {
                svg.append("text")
                    .attr("x", WIDTH/2).attr("y", HEIGHT/2)
                    .attr("text-anchor", "middle").attr("font-size", "16px")
                    .style("fill", "#a0a0c0")
                    .text("ðŸ”„ Live data...");
                return;
            }

            const margin = {top: 40, right: 20, bottom: 50, left: 40};
            const plotHeight = HEIGHT - margin.top - margin.bottom;
            const candleWidth = Math.max(3, (WIDTH - margin.left - margin.right) / prices.length * 0.9);
            
            // Last 20 candles (mobile optimized)
            const ohlcData = prices.slice(-20).map((d, i) => ({
                date: i,
                open: d.price + (Math.random() - 0.5) * 0.2,
                high: d.price + Math.random() * 0.4,
                low: d.price - Math.random() * 0.4,
                close: d.price,
                volume: d.volume
            }));

            const x = d3.scaleLinear()
                .domain([0, ohlcData.length-1])
                .range([margin.left, WIDTH - margin.right]);
                
            const y = d3.scaleLinear()
                .domain([d3.min(ohlcData, d=>d.low)*0.98, d3.max(ohlcData, d=>d.high)*1.02])
                .range([plotHeight + margin.top, margin.top]);

            // Candlesticks
            const candleGroups = svg.selectAll(".candle")
                .data(ohlcData)
                .enter().append("g")
                .attr("transform", (d,i) => `translate(${x(i)}, 0)`);

            candleGroups.append("line")  // Wicks
                .attr("x1", 0).attr("x2", 0)
                .attr("y1", d => y(d.high))
                .attr("y2", d => y(d.low))
                .attr("stroke", "#a0a0a0")
                .attr("stroke-width", 1);

            candleGroups.append("rect")  // Bodies
                .attr("x", -candleWidth/2)
                .attr("width", candleWidth)
                .attr("y", d => Math.min(y(d.open), y(d.close)))
                .attr("height", d => Math.abs(y(d.open) - y(d.close)))
                .attr("fill", d => d.close >= d.open ? "#00ff88" : "#ff4444")
                .attr("stroke", d => d.close >= d.open ? "#00cc66" : "#cc3333")
                .attr("stroke-width", 0.5);

            // Mobile axes (simplified)
            svg.append("g")
                .attr("transform", `translate(0,${HEIGHT - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(4).tickFormat(""))
                .style("font-size", "10px").style("color", "#a0a0c0");
                
            svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y).ticks(4).tickFormat(d3.format("$~s")))
                .style("font-size", "10px").style("color", "#a0a0c0");

            // Header (scaled)
            svg.append("text")
                .attr("x", WIDTH/2).attr("y", 25)
                .attr("text-anchor", "middle")
                .attr("font-size", "16px")
                .attr("font-weight", "bold")
                .style("fill", "#ffffff")
                .text("ðŸ“Š IBM Live");

            // Live dot (most recent)
            const last = ohlcData[ohlcData.length-1];
            svg.append("circle")
                .attr("cx", x(ohlcData.length-1))
                .attr("cy", y(last.close))
                .attr("r", 6)
                .attr("fill", "#ff6b6b")
                .style("filter", "drop-shadow(0 0 6px rgba(255,107,107,0.7))");
        }
        // RUN
        setInterval(fetchStockData, 2000);
        setInterval(() => {
            updateStats();
            renderChart();
        }, 1000);
        
        fetchStockData();
        updateStats();
        renderChart();
    </script>
</body>
</html>
