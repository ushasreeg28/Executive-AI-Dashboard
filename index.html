<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI + Finance Live Dashboard | Usha Sree</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100vh; 
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #0a0a1a 0%, #1a0a2e 50%, #16213e 100%);
            color: white;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(20px);
            padding: 0.8rem 5%;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.4rem;
            font-weight: 800;
            background: linear-gradient(45deg, #ff6b9d, #c44569, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        
        .header-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
            color: #a0a0c0;
            margin: 0.2rem 0 0 0;
        }
        
        .tabs {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }
        
        .tab-btn {
            flex: 1;
            padding: 0.8rem;
            background: none;
            border: none;
            color: #a0a0c0;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            color: #00d4ff;
            background: rgba(0,212,255,0.1);
            border-bottom: 3px solid #00d4ff;
        }
        
        .tab-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem 5%;
            gap: 1rem;
            overflow: hidden;
            position: relative;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            flex-shrink: 0;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover { transform: translateY(-3px); border-color: rgba(0,212,255,0.5); }
        .stat-value { font-size: 1.6rem; font-weight: 800; line-height: 1; margin-bottom: 0.3rem; }
        .stat-label { font-size: 0.8rem; opacity: 0.8; }
        
        .status { 
            background: rgba(40,167,69,0.2); 
            border: 1px solid rgba(40,167,69,0.4); 
            padding: 0.8rem; 
            border-radius: 10px; 
            font-family: 'Courier New', monospace; 
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .chart-container {
            flex: 1;
            background: rgba(0,0,0,0.4);
            border-radius: 20px;
            padding: 1rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            overflow: hidden;
            position: relative;
            display: block;
        }
        
        #ai-chart, #stock-chart { width: 100% !important; height: 100% !important; display: block; }
        .tab-pane { display: none; }
        .tab-pane.active { display: flex; flex-direction: column; }
        
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.2rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        /* FIXED LAYOUT & TOOLTIP */
        .chart-container {
            padding: 1.5rem !important;  /* Increased padding */
            margin-top: 0.5rem;
        }

        .tooltip {
            position: fixed !important;      /* FIXED: Always visible */
            z-index: 1000 !important;
            background: rgba(0,0,0,0.95) !important;
            border: 1px solid #00d4ff !important;
            border-radius: 12px !important;
            padding: 14px !important;
            font-size: 13px !important;
            backdrop-filter: blur(15px) !important;
            box-shadow: 0 12px 40px rgba(0,0,0,0.6) !important;
            pointer-events: none !important;
            max-width: 220px;
            opacity: 0;
            transition: all 0.25s ease !important;
        }

        .tooltip.show {
            opacity: 1 !important;
            transform: translateY(-5px) !important;
        }

        /* RESPONSIVE CONTAINER */
        .tab-content {
            padding: 1.5rem 3% !important;  /* More breathing room */
            gap: 1.5rem !important;
        }


    </style>
</head>
<body>
    <header class="header">
        <h1>ü§ñ AI + üìà Finance Live Dashboard</h1>
        <p class="header-subtitle">Real-time LLM Metrics + Stock Trading | Firebase + D3.js</p>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('ai')">ü§ñ AI Metrics</button>
        <button class="tab-btn" onclick="switchTab('stock')">üìà Stocks</button>
    </div>

    <!-- AI METRICS TAB -->
    <div id="ai-tab" class="tab-content tab-pane active">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="ai-latency">245ms</div>
                <div class="stat-label">Avg Latency</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="ai-tokens">1.2k</div>
                <div class="stat-label pulse" id="ai-tokens-label">Tokens/sec</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="ai-cost">$0.023</div>
                <div class="stat-label">Cost/min</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="ai-qps">12.4</div>
                <div class="stat-label">Queries/sec</div>
            </div>
        </div>
        <div class="status" id="ai-status">üîÑ Connecting to AI pipeline...</div>
        <div class="chart-container">
            <svg id="ai-chart"></svg>
        </div>
    </div>

    <!-- STOCKS TAB -->
    <div id="stock-tab" class="tab-content tab-pane">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stock-price">$145.23</div>
                <div class="stat-label">IBM Price</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stock-change">+1.45%</div>
                <div class="stat-label pulse" id="stock-change-label">24hr Change</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stock-volume">8.4M</div>
                <div class="stat-label">Volume</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stock-points">47</div>
                <div class="stat-label">Data Points</div>
            </div>
        </div>
        <div class="status" id="stock-status">üîÑ Loading market data...</div>
        <div class="chart-container">
            <svg id="stock-chart"></svg>
        </div>
    </div>

    <script src="secrets.js"></script>
<script>
    /// üî• GLOBAL VARIABLES - accessible everywhere
    let firebaseApp = null;
    let db = null;  // This will be your global db

    function initFirebase() {
        // Wait for config AND firebase
        if (!window.API_CONFIG || !firebase || firebase.apps.length > 0 || window.API_CONFIG.firebase.apiKey === 'demo-disabled') {
            setTimeout(initFirebase, 100);
            return;
        }
        
        try {
            // console.log('üöÄ Initializing with:', window.API_CONFIG.firebase.databaseURL);
            firebaseApp = firebase.initializeApp(window.API_CONFIG.firebase);
            db = firebaseApp.database();  // ‚úÖ GLOBAL db
                        // Now start your app
            startApp();
            
        } catch(e) {
            console.error('Firebase init failed:', e);
        }
    }
    
    // TABS
    function switchTab(tab) {
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tab + '-tab').classList.add('active');
        event.target.classList.add('active');
    }

        


    // Your app starts HERE - ALL your existing code
    function startApp() {
        if (!db) {
            console.error('‚ùå DB not ready yet');
            return;
        }
        
        // MOVE ALL YOUR EXISTING FIREBASE CODE HERE:
        console.log('üåü Using db:', db);
        
        


        
        // State
        let stockPrices = [];
        // ‚úÖ INSTANT DEFAULT DATA - Shows chart IMMEDIATELY
        let aiMetrics = [
            { modelName: 'Llama-3.2-1B', downloads: 1250000, likes: 3421, library: 'transformers', time: Date.now() - 60000 },
            { modelName: 'Mistral-7B', downloads: 850000, likes: 2890, library: 'transformers', time: Date.now() - 50000 },
            { modelName: 'DialoGPT-med', downloads: 420000, likes: 1567, library: 'transformers', time: Date.now() - 40000 },
            { modelName: 'GPT2', downloads: 950000, likes: 4123, library: 'transformers', time: Date.now() - 30000 },
            { modelName: 'Llama-3.2-1B', downloads: 1280000, likes: 3478, library: 'transformers', time: Date.now() - 20000 },
            { modelName: 'Mistral-7B', downloads: 870000, likes: 2956, library: 'transformers', time: Date.now() - 10000 },
            { modelName: 'DialoGPT-med', downloads: 435000, likes: 1623, library: 'transformers', time: Date.now() },
            { modelName: 'GPT2', downloads: 975000, likes: 4189, library: 'transformers', time: Date.now() }
        ];

        let aiState = { 
            model: 'Llama-3.2-1B', 
            downloads: '1.25M', 
            likes: 3421, 
            library: 'transformers' 
        };
        let stockState = { price: 145.23, change: "+1.45%", volume: 8400000, points: 0 };
        // STOCK CANDLESTICK (your existing)
        function renderStockChart() {
            const container = document.querySelector('#stock-tab .chart-container');
            const WIDTH = container.clientWidth - 20;
            const HEIGHT = container.clientHeight - 10;
            
            const svg = d3.select("#stock-chart");
            svg.attr("width", WIDTH).attr("height", HEIGHT).selectAll("*").remove();
            
            if (stockPrices.length < 5) {
                svg.append("text").attr("x", WIDTH/2).attr("y", HEIGHT/2)
                    .attr("text-anchor", "middle").attr("font-size", "16px")
                    .style("fill", "#a0a0c0").text("üìà Loading stocks...");
                return;
            }

            const margin = {top: 40, right: 20, bottom: 50, left: 40};
            const plotHeight = HEIGHT - margin.top - margin.bottom;
            const candleWidth = Math.max(3, (WIDTH - margin.left - margin.right) / stockPrices.length * 0.9);
            
            const ohlcData = stockPrices.slice(-20).map((d, i) => ({
                date: i,
                open: d.price + (Math.random() - 0.5) * 0.2,
                high: d.price + Math.random() * 0.4,
                low: d.price - Math.random() * 0.4,
                close: d.price,
                volume: d.volume
            }));

            const x = d3.scaleLinear().domain([0, ohlcData.length-1]).range([margin.left, WIDTH - margin.right]);
            const y = d3.scaleLinear()
                .domain([d3.min(ohlcData, d=>d.low)*0.98, d3.max(ohlcData, d=>d.high)*1.02])
                .range([plotHeight + margin.top, margin.top]);

            const candleGroups = svg.selectAll(".candle").data(ohlcData).enter().append("g")
                .attr("transform", (d,i) => `translate(${x(i)}, 0)`);

            candleGroups.append("line")
                .attr("x1", 0).attr("x2", 0)
                .attr("y1", d => y(d.high)).attr("y2", d => y(d.low))
                .attr("stroke", "#a0a0a0").attr("stroke-width", 1);

            candleGroups.append("rect")
                .attr("x", -candleWidth/2).attr("width", candleWidth)
                .attr("y", d => Math.min(y(d.open), y(d.close)))
                .attr("height", d => Math.abs(y(d.open) - y(d.close)))
                .attr("fill", d => d.close >= d.open ? "#00ff88" : "#ff4444")
                .attr("stroke", d => d.close >= d.open ? "#00cc66" : "#cc3333")
                .attr("stroke-width", 0.5);

            svg.append("g").attr("transform", `translate(0,${HEIGHT - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(4).tickFormat(""))
                .style("font-size", "10px").style("color", "#a0a0c0");
                
            svg.append("g").attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y).ticks(4))
                .style("font-size", "10px").style("color", "#a0a0c0");

            svg.append("text").attr("x", WIDTH/2).attr("y", 25)
                .attr("text-anchor", "middle").attr("font-size", "16px")
                .attr("font-weight", "bold").style("fill", "#fff")
                .text("üìà IBM Live Candlesticks");
        }

        // FIXED: REAL HUGGING FACE DATA CHART
        async function fetchRealAIMetrics() {
            try {
                const models = ['meta-llama/Llama-3.2-1B-Instruct', 'mistralai/Mistral-7B-Instruct-v0.3', 
                            'microsoft/DialoGPT-medium', 'gpt2'];
                const randomModel = models[Math.floor(Math.random() * models.length)];
                const response = await fetch(`https://huggingface.co/api/models/${randomModel}`);
                const data = await response.json();
                
                // ‚úÖ MERGE real data with existing array (no empty states)
                const newPoint = {
                    modelName: randomModel.split('/')[1],
                    downloads: data.downloads || 100000 + Math.random() * 500000,
                    likes: data.likes || 1000 + Math.random() * 2000,
                    library: data.library_name || 'transformers',
                    lastModified: data.lastModified,
                    time: Date.now()
                };
                
                // Add new point and keep last 12
                aiMetrics.push(newPoint);
                if (aiMetrics.length > 12) aiMetrics.shift();
                
                // Update stats display
                aiState = {
                    model: newPoint.modelName,
                    downloads: (newPoint.downloads/1000).toFixed(0) + 'k',
                    likes: newPoint.likes,
                    library: newPoint.library
                };
                
                document.getElementById('ai-status').textContent = 
                    `‚úÖ Live: ${aiState.model} | ${aiState.downloads} ‚Üì`;
                    
                db.ref('ai/metrics').set(newPoint);
                
            } catch (error) {
                console.log("Using fallback data...", error);
                // Fallback: shift existing data to simulate live updates
                aiMetrics.push({
                    modelName: ['Llama-3.2', 'Mistral-7B', 'DialoGPT', 'GPT2'][Math.floor(Math.random()*4)],
                    downloads: aiMetrics[aiMetrics.length-1]?.downloads * (0.95 + Math.random()*0.1),
                    likes: aiMetrics[aiMetrics.length-1]?.likes * (0.98 + Math.random()*0.04),
                    library: 'transformers',
                    time: Date.now()
                });
                if (aiMetrics.length > 12) aiMetrics.shift();
            }
        }
        
        // PERFECTLY READABLE CHART - DIRECTLY SHOWS HF DATA
        function renderAIMetrics() {
            const container = document.querySelector('#ai-tab .chart-container');
            const WIDTH = Math.max(450, container.clientWidth - 40);
            const HEIGHT = Math.max(380, container.clientHeight - 30);

            const svg = d3.select("#ai-chart");
            svg.attr("width", WIDTH).attr("height", HEIGHT);

            if (aiMetrics.length < 2) return;

            // ‚úÖ FIXED MARGINS
            const margin = {top: 50, right: 80, bottom: 80, left: 70};
            const plotWidth = WIDTH - margin.left - margin.right;
            const plotHeight = HEIGHT - margin.top - margin.bottom;

            const g = svg.selectAll("g.chart-group").data([1]);
            g.enter().append("g").attr("class", "chart-group")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            g.attr("transform", `translate(${margin.left},${margin.top})`);

            // DATA
            const chartData = aiMetrics.slice(-10).map((d, i) => ({
                time: i,
                downloads: d.downloads || 1000,
                likes: d.likes || 50,
                model: d.modelName?.substring(0,12) || 'Model',
                library: d.library || 'transformers'
            }));

            // SCALES
            const xScale = d3.scaleLinear().domain([0, chartData.length-1]).range([0, plotWidth]);
            const yDownloads = d3.scaleLinear()
                .domain([0, d3.max(chartData, d => d.downloads) * 1.1])
                .range([plotHeight, 0]);
            const yLikes = d3.scaleLinear()
                .domain([0, d3.max(chartData, d => d.likes) * 1.2])
                .range([plotHeight * 0.7, 0]);

            // ‚úÖ FIXED BARS - UPDATE EXISTING, DON'T RECREATE
            // ‚úÖ FIXED BARS with MIN HEIGHT (5px) & WIDTH (18px)
            const MIN_BAR_HEIGHT = 5;
            const MIN_BAR_WIDTH = 18;

            const bars = g.selectAll(".bars").data(chartData, d => d.time);
            bars.exit().remove();

            // UPDATE existing bars
            bars.transition().duration(500)
                .attr("x", d => xScale(d.time) - 10)
                .attr("width", MIN_BAR_WIDTH)  // ‚úÖ FIXED MIN WIDTH
                .attr("y", d => {
                    const yPos = yDownloads(Math.max(1, d.downloads));
                    return Math.max(0, yPos - MIN_BAR_HEIGHT);  // ‚úÖ Ensure min height space
                })
                .attr("height", MIN_BAR_HEIGHT);  // ‚úÖ FIXED MIN HEIGHT

            // NEW bars enter smooth
            bars.enter().append("rect")
                .attr("class", "bars")
                .attr("fill", "#3b82f6")
                .attr("width", MIN_BAR_WIDTH)  // ‚úÖ FIXED MIN WIDTH
                .attr("rx", 2)
                .attr("opacity", 0.9)
                .attr("x", d => xScale(d.time) - 10)
                .attr("y", plotHeight)
                .attr("height", 0)
                .transition().duration(500)
                .attr("y", d => {
                    const yPos = yDownloads(Math.max(1, d.downloads));
                    return Math.max(0, yPos - MIN_BAR_HEIGHT);  // ‚úÖ Ensure min height space
                })
                .attr("height", MIN_BAR_HEIGHT);  // ‚úÖ FIXED MIN HEIGHT

            // ‚úÖ FIXED LINE - SMOOTH UPDATE
            const linePath = g.selectAll(".line-path").data([chartData]);
            linePath.enter().append("path")
                .attr("class", "line-path")
                .attr("fill", "none")
                .attr("stroke", "#f59e0b")
                .attr("stroke-width", 4)
                .attr("stroke-linecap", "round");
            linePath.transition().duration(500)
                .attr("d", d3.line().x(d => xScale(d.time)).y(d => yLikes(d.likes)));

            // ‚úÖ FIXED BUBBLES
            const bubbles = g.selectAll(".bubbles").data(chartData, d => d.time);
            bubbles.exit().remove();
            bubbles.transition().duration(500)
                .attr("cx", d => xScale(d.time))
                .attr("cy", d => yLikes(d.likes))
                .attr("r", d => Math.max(8, Math.log(d.likes + 10)));
            bubbles.enter().append("circle")
                .attr("class", "bubbles")
                .attr("stroke", "#fff")
                .attr("stroke-width", 2)
                .attr("fill", d => d.library === 'transformers' ? '#10b981' : '#ef4444')
                .attr("cx", d => xScale(d.time))
                .attr("cy", yLikes(0))
                .attr("r", 0)
                .transition().duration(500)
                .attr("cy", d => yLikes(d.likes))
                .attr("r", d => Math.max(8, Math.log(d.likes + 10)));

            // AXES (update only when needed)
            const xAxis = g.selectAll(".x-axis").data([1]);
            xAxis.enter().append("g").attr("class", "x-axis")
                .attr("transform", `translate(0,${plotHeight})`);
            xAxis.transition().duration(500)
                .call(d3.axisBottom(xScale).ticks(4))
                .style("color", "#94a3b8");

            const yAxis = g.selectAll(".y-axis").data([1]);
            yAxis.enter().append("g").attr("class", "y-axis");
            yAxis.transition().duration(500)
                .call(d3.axisLeft(yDownloads).ticks(4))
                .style("color", "#94a3b8");

            // TITLE (static)
            svg.selectAll(".title").data([1]).enter()
                .append("text").attr("class", "title")
                .attr("x", WIDTH/2).attr("y", 30)
                .attr("text-anchor", "middle")
                .attr("font-size", "20px").attr("font-weight", "700")
                .style("fill", "#fff")
                .text("ü§ñ AI Model Live Analytics");

            // PERFECT SMOOTH TOOLTIP
            function showTooltip(event, d) {
                d3.selectAll(".tooltip").remove();
                d3.select("body").append("div")
                    .attr("class", "tooltip show")
                    .style("left", Math.min(event.pageX + 15, window.innerWidth - 250) + "px")
                    .style("top", (event.pageY - 50) + "px")
                    .html(`<strong>${d.model}</strong><br/>üì• ${d.downloads.toLocaleString()}<br/>‚ù§Ô∏è ${d.likes}`);
            }

            // Apply hover to all elements
            g.selectAll(".bars, .bubbles")
                .on("mousemove", function(event) {
                    const index = d3.select(this).datum().time;
                    showTooltip(event, chartData[index]);
                })
                .on("mouseleave", () => d3.selectAll(".tooltip").remove());
        }

        // STOCK DATA GENERATOR
        function generateStockData() {
            const newPrice = stockState.price + (Math.sin(Date.now() / 10000) * 0.5) + (Math.random() - 0.5) * 0.3;
            stockState.price = Math.max(140, Math.min(155, newPrice));
            
            const newPoint = {
                price: stockState.price,
                volume: Math.floor(Math.random() * 5000000) + 5000000,
                change: ((Math.random() - 0.5) * 3).toFixed(2) + '%',
                time: Date.now()
            };
            
            stockPrices.push(newPoint);
            if (stockPrices.length > 75) stockPrices.shift();
            
            stockState.change = newPoint.change;
            stockState.volume = newPoint.volume;
            stockState.points = stockPrices.length;
            
            db.ref('stocks/IBM').set(newPoint);
            document.getElementById('stock-status').textContent = 
                `‚úÖ IBM: $${stockState.price.toFixed(2)} | ${stockState.points} pts`;
        }

        function updateAIStats() {
            document.getElementById('ai-latency').textContent = aiState.model || 'Loading...';
            document.getElementById('ai-tokens').textContent = aiState.downloads || 'N/A';
            document.getElementById('ai-cost').textContent = aiState.library || 'N/A';
            document.getElementById('ai-qps').textContent = aiState.likes?.toLocaleString() || '0';
        }


        function updateStockStats() {
            document.getElementById('stock-price').textContent = `$${stockState.price.toFixed(2)}`;
            document.getElementById('stock-change').textContent = stockState.change;
            document.getElementById('stock-volume').textContent = (stockState.volume/1000000).toFixed(1) + 'M';
            document.getElementById('stock-points').textContent = stockState.points;
        }

        // RUN EVERYTHING
        setInterval(fetchRealAIMetrics, 10000);
        setInterval(generateStockData, 3000);
        setInterval(() => {
            updateAIStats(); updateStockStats();
            renderAIMetrics(); renderStockChart();
        }, 1000);

        // Initial load
        fetchRealAIMetrics(); generateStockData();
        updateAIStats(); updateStockStats();
        renderAIMetrics(); renderStockChart();
    }

    // Auto-start
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFirebase);
    } else {
        initFirebase();
    }
    </script>
</body>
</html>
